# 우아한 테크 세미나(ATDD)
<br>

- ### 서론


    - 오늘의 세미나는 교육 플랫폼(넥스트 스텝)을 개발하는 과정에서 제가 했던 경험을 기반을 진행할 것이고, 인수 테스트 주도 개발(ATDD)에 대한 내용을 다루려고 합니다.

    - 이야기 하지 않는 부분
        - ATDD라고 하면 cucumber이나 jbehave이라는 BDD 도구를 떠올리실텐데, 저는 이번 세미나에서 다루지 않을 예정이고,
        - MicroServices 혹은 Multi Module에서의 ATDD 환경도 다루지 않을 예정입니다.
        - 또한, “ATDD를 하면 무조건 좋으니깐 하세요.” 라는 말도 하지 않을 예정입니다.
        - ATDD가 처음이신 분들한테는 ‘아 이런게 있다’ 정도로 생각해주시면 될 것 같구요,
        - 이미 관심이 있으신 분들에게는 ‘아 이런 방식으로도 개발을 해나갈 수 있다’라는 생각이 들게끔 하는게 이번 세미나의 목표입니다.
        - ‘ATDD 필승전략 이렇게 하면 성공한다’ 이런 이야기도 하지 않을 예정입니다.
        - 어떤 상황을 통해서 어떻게 고민하고 해결 했는지에 알려드릴 것이다.
<br>


- ### 본론


    - 인수 테스트를 접하게 된 계기
        - 우아한 형제들의 개발 문화
            - 페어 프로그래밍 : 즉각적인 피드백 👍🏻
            - 테스트 작성 권장 : 시간과 인원의 제약으로 혼자 프로그래밍을 할 때 테스트 코드는 심리적 안정감을 제공
            - 인수 테스트 ⭕️
                - 시나리오(사용자 스토리) 기반으로 한 E2E 테스트
                - 배포 없이 대부분의 기능을 검증 → 빠른 피드백
                - 새로운 도메인과 서비스 흐름 파악에 도움
            - 인수 테스트 ❌
                - 배포해서 기능을 일일히 확인 필요
                - 화면을 다 만들어야하는 번거로움
            - **결론 : 우아한 형제들의 개발 문화(테스트 주도 개발)를 통해서 빠르게 피드백 받으면서 적응하고 성장할 수 있었다.**

    - 테스트 주도 개발
        - TDD 수행시 아쉬웠던 부분이 있었음(익숙하지 않았던 시절)
            - 어떻게 시작하고 언제 끝나지 불명확
            - 각 단위들이 잘 통합 되는지 불명확
        - **이를 해결하기 위해 인수 테스트(ATDD)를 먼저 작성하고 TDD 사이클을 진행했다.**
            - 인수 테스트로 전체 기능에 대한 가이드 라인을 잡고
            - 인수 테스트를 충족하기 위해서 테스트 코드 작성
        
    - ATDD 소개
        - TDD와 어떤 관계인지?
        - BDD와 어떤 관계인지?
        - 하지만, 용어에 너무 빠지지 않고, 용어의 개념에 대해서만 학습하면 된다.
        - 테스트 vs TDD
        
            <img src="https://user-images.githubusercontent.com/88137420/214756448-09884582-cdea-4022-ab0d-423e08b13408.png" width="700">

        
            - 테스트 관점(하루를 마치면서 일기를 쓰는 행위) : 구현 했던 것을 테스트 코드로 검증
            - TDD 관점(하루를 시작하면서 해야할 TODO 리스트를 작성) : 구현 해야할 요구사항을 테스트 코드로 먼저 작성하고 구현
        - TDD vs BDD
        
             <img src="https://user-images.githubusercontent.com/88137420/214756524-5e569488-c328-4766-a85d-de022c83bc5f.png" width="700">


            - BDD는 TDD의 Test를 Behavior로 대체한 개념
            - 즉, BDD는 TDD를 더 잘 하고 잘 설명하기 위해 나온 개념
            - 초창기 TDD는 요구 사항의 명세가 아닌 테스트의 개념으로 의미가 잘못 해석이 되곤 했다.
            - 이를 보완하기 위해 테스트를 행위로 대체 시키면서 BDD가 생겼다.
            - BDD의 특징으로는
                - given / when / then 형식으로 작성
                - 행위에 시작하다보니, outside에서 inside로 TDD를 진행함
                    - mockito TDD / outsidein TDD라고도 함
        - TDD vs BDD vs ATDD
        
            <img src="https://user-images.githubusercontent.com/88137420/214756586-05bef65d-73ca-4155-b224-3c3c7e163550.png" width="700">


            - 요구사항을 인수테스트(AT)로 정의하고 명세합니다.
            - given / when / then 형식으로 작성(BDD와 비슷하다고 생각되는 이유)
            - ATDD는 TDD처럼 개발에만 관련된 용어는 아니다.
            - ATDD는 기획, 개발, QA가 함께 협업하기 위한 애자일 방법론 중에 하나이다.(인수 조건을 하나로 명시하기 위함)
            - 인수 조건을 하나로 정의하는 이유 ?
                - 요구사항을 잘못 이해하여 각 부서간 추가 커뮤니케이션 비용 발생

    - ATDD 개발 프로세스
        - 인수 조건 정의
        - 인수 테스트 작성
        - 기능 구현
        - 예시
            - 기능 : 수강 신청 기간에 정원이 다 차서 대기 신청
            - 인수 조건 정의 :
                - given(선행 조건)
                    - 강사는 강의를 생성했다.
                    - 강사는 강의를 신청 가능 상태로 변경하였다.
                    - 강의 모집인원 만큼 신청을 받았다.
                - when(행위)
                    - 회원이 수강 대기 신청을 요청한다.
                - then(결과)
                    - 회원은 강의의 수강 대기자로 등록 되었다.
            - **참고 사항 : 실제 요청/응답 하는 환경과 유사하게 테스트 환경을 구성**

    - 개발 관점의 ATDD 경험 공유
        - 인수 정의
            - 인수 정의 : 주문한 물건이 맞는지 확인하고 받는다.
            - (프로그래밍) 인수 정의 : 요구사항에 맞게 개발 되었는지 확인하고 받는다.
        - 인수 조건 만들기
            - 요구사항(사용자 스토리) : 누가 / 왜 / 무엇 [크게 중요한 것은 아니다.]
            - 인수 조건 표현 :
                - given(사전 조건)
                - when(검증 대상)
                - then(기대 결과)
            - 인수 조건 작성(순서) :
                1. 검증 하고자 하는 when 구문 먼저 작성
                2. 기대 결과를 의미하는 then 구문 작성
                3. when과 then에서 필요한 정보를 given을 통해 마련
            - 인수 조건을 ‘이슈’로 관리(처음부터 완벽할 수 없으니, 추가적으로 인수 조건을 계속 수정)            
                
                <img src="https://user-images.githubusercontent.com/88137420/214756639-d4258a4e-8612-4468-b5ae-c3286e669f5f.png" width="700">


            
            - 인수 테스트 특징
                - 블랙박스 테스트
                    - 개발적인 지식이 없고 구체적인 구현보다는 사용자 관점에서 기능이 잘 동작하는지 확인
                - UI 레벨 대신 API 레벨 인수 테스트
                    - UI 레벨을 테스트하기는 너무 어렵기 때문에(변동성이 많기에), API 레벨까지만 테스트
            - 테스트 도구
                - 테스트 서버(환경)
                    - @SpringbootTest
                        - webEnvironment 속성을 사용하여 테스트 서버가 실제 웹 환경과 유사한 RANDOM_PORT 설정
                        - 웹 환경(tomcat, netty) ↔ mock 환경
                - 테스트 클라이언트
                    - MockMVC, WebTestClient, RestAssured
                - MockMVC vs WebTestClient vs RestAssured
                    - MockMVC : mocking된 web environment 환경에서 테스트
                    - WebTestClient : RANDOM_PORT와 DEFINED_PORT를 함께 사용(Netty)
                    - RestAssured : 실제 webEnvironment(Apache Tomcat)을 사용하여 테스트)
                - 테스트 데이터 초기화
                    - 테스트 객체를 이용하여 직접 호출 후 초기화
                    - 테스트가 다른 테스트에 영향을 주는 상황
                        - 이유 : 테스트가 같은 환경에서 돌아가기 때문에 발생하는 문제
                            - 스프링 테스트에서는 효과적인 테스트를 위해서 컨텍스트를 캐싱하고 있다.
                            - 첫번 째만 빈들을 로드하고 컨텍스트를 만든다.
                            - 이후, 변경사항(훼손)이 없다면 캐싱된 컨텍스트를 사용한다.
                        - 해결하기 위해 사용한 방법 : @DirtiesContext(비효율적)
                            - 스프링 테스트 환경에서 캐싱된 Context를 사용하지 않게 설정
                            - 매번 Context를 새로 구성하다보니 시간이 많이 걸림
                    - 일괄적인 데이터 초기화
                        - EntityManager를 활용하여 테이블 이름 조회
                        - 각 테이블 Truncate 수행
                        - ID auto increment 값 초기화
                - 중복 처리 & 가독성 개선 필요
                    - given구문 - 수 많은 코드들의 중복 및 가독성이 좋지 않음
                        - 메서드 분리
                        - 클래스 분리 : 다른 클래스에서도 재사용할 수 있도록 클래스 분리
                        - 한글 메서드 네이밍 : 의도를 정확하게 드러내기 / 컨벤션 중요 / 팀원과 협의 필요
                    - 외부 API 호출
                        - Github API 연동 : 테스트 계정으로 실제 요청
                        - 결제 API 연동 : 실제가 아닌 Fake 서비스에 요청하도록 구성
                - 인수 테스트 작성 팁
                    - 간단한(동작 가능한) 성공 케이스 우선 작성
                    - 인수 테스트 클래스 : 같은 테스트 픽스처를 공유하는 인수 테스트를 클래스 단위로 묶음
                    - Live Templates - IntelliJ

    - 인수 테스트(ATDD) 다음 TDD
        - 인수 테스트 주도 개발
        - Outside In TDD
            - BDD에서는 Outside In 방식의 TDD를 말한다
        - 도메인 부터 TDD
            - 인수 테스트를 통해 시나리오 및 전반적인 기능에 대한 이해를 했다면
            - 핵심 기능에 대한 도메인 설계를 한 후 도메인 객체에 대한 TDD를 수행

    - 추천하는 흐름
        - Top-Down(인수 테스트)으로 방향을 잡고, Bottom-Up으로 구현하기
        - 인수 테스트 작성을 통해 요구사항과 기능 전반에 대한 이해를 선행
        - 내부 구현에 대한 설계 흐름을 구상
        - 설계가 끝나면 도메인부터 차근차근 TDD로 기능 구현
        - 만약 도메인이 복잡하거나 설계가 어려울 경우 이해하고 있는 부분 먼저 기능 구현
        - 인수 테스트의 요청을 처리하는 부분부터 진행할 수 있음
<br>

- ### 결론


    - ATDD 도입해보기
        - 나 혼자 ATDD
            - 토이 프로젝트, 간단한 기능부터
            - 경험해보면서 상황에 맞는 방법 찾기
        - 다함께 ATDD(in 개발팀)
            - ATDD 개발 프로세서 룰 정하기(인수 조건, 포맷 등)
            - 팀 회의와 회고를 통한 피드백
            - 살아있는 규칙 정하기
        - 성공적인 ATDD 적용을 위해
            - 아주 쉽게 시작할 수 있는 부분부터 도입
            - 조금씩 상황에 맞게 조정
            - 문제점 발견시 민첩하게 대응
            - 기록을 남겨두기
        - 레거시 기반 인수 테스트 작성하기
            - 먼저 인수 테스트를 작성하여 기존에 구현된 기능을 보호 → 리팩토링
        - 인수 테스트 작성 가이드 작성하기

    - 기획 & QA와 함께하는 ATDD
        - 기획자와 QA 담당자 설득하기
        - 함께 만드는 인수 조건
            - 화면 기반으로 작성할 경우 이해도가 높음
            - 모든 인수 조건을 다 같이 만드는 것 비효율적

    - ATDD 적용의 장, 단점
        - 장점
            - 다른 포지션의 관점은 물론 업무 프로세서도 간접적으로 익힐 수 있음
            - 다른 포지션의 진행 상황에 대한 인지와 이해도가 높아짐
        - 단점
            - 인수 조건의 정의가 어려움
            - 문서나 규칙을 정하기가 어려움
<br>

- ### 마무리


    - 실제적으로 적용하기가 어려울 수도 있을 것이라고 느낀다.
    - 자료가 많지 않아서 힘들었다.
    - 이러한 주제로 더 많은 이야기를 함께 만들어갔으면 좋겠다.
<br>
